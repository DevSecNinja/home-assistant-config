---
name: "Validate Configuration"

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  yaml-lint:
    name: "YAML Linting"
    runs-on: "ubuntu-24.04"
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"
        
      - name: "Set up Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
          
      - name: "Install yamllint"
        run: |
          python -m pip install --upgrade pip
          pip install yamllint
          
      - name: "Run yamllint"
        run: |
          yamllint --version
          yamllint .

  hassfest:
    name: "Home Assistant Config Validation (hassfest)"
    runs-on: "ubuntu-24.04"
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"
        
      - name: "Run hassfest validation"
        uses: "home-assistant/actions/hassfest@master"

  esphome-check:
    name: "ESPHome Configuration Validation"
    runs-on: "ubuntu-24.04"
    if: hashFiles('esphome/*.yaml') != ''
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"
        
      - name: "Set up Python"
        uses: "actions/setup-python@v5"
        with:
          python-version: "3.12"
          
      - name: "Install ESPHome"
        run: |
          python -m pip install --upgrade pip
          pip install esphome
          
      - name: "Validate ESPHome configurations"
        run: |
          echo "Checking ESPHome configurations..."
          for config in esphome/*.yaml; do
            if [[ -f "$config" ]]; then
              echo "Validating $config"
              esphome config "$config"
            fi
          done

  home-assistant-check:
    name: "Home Assistant Configuration Check"
    runs-on: "ubuntu-24.04"
    continue-on-error: true  # Don't fail the entire workflow if HA config has issues
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"
        
      - name: "Create secrets file with common secrets"
        run: |
          # Create a comprehensive dummy secrets.yaml for validation
          # This includes common secrets found in Home Assistant configurations
          cat > secrets.yaml << 'EOF'
          # Dummy secrets for validation - DO NOT USE IN PRODUCTION
          
          # Basic Home Assistant secrets
          api_password: dummy_password
          http_base_url: http://localhost:8123
          latitude: 52.3676
          longitude: 4.9041
          elevation: 0
          time_zone: Europe/Amsterdam
          
          # Database and InfluxDB secrets
          db_url: sqlite:///home-assistant_v2.db
          influxdb_host: localhost
          influxdb_port: 8086
          influxdb_database: homeassistant
          influxdb_username: dummy_user
          influxdb_password: dummy_password
          influxdb_homeassistant_host: localhost
          
          # MQTT secrets
          mqtt_host: localhost
          mqtt_port: 1883
          mqtt_username: dummy_user
          mqtt_password: dummy_password
          
          # Network and device secrets
          router_host: 192.168.1.1
          router_username: admin
          router_password: dummy_password
          
          # Notification secrets
          telegram_api_key: dummy_key
          telegram_chat_id: 123456789
          
          # External API keys
          openweather_api_key: dummy_key
          google_api_key: dummy_key
          
          # Device secrets
          device_tracker_secret: dummy_secret
          alarm_code: "1234"
          
          # Add commonly used secrets
          admin_password: dummy_password
          guest_password: dummy_password
          api_key: dummy_api_key
          access_token: dummy_token
          client_id: dummy_client_id
          client_secret: dummy_client_secret
          EOF
          
      - name: "Run Home Assistant config check"
        run: |
          # Use docker to run Home Assistant config check in a controlled environment
          docker run --rm \
            -v "$PWD":/config \
            -w /config \
            homeassistant/home-assistant:stable \
            python -m homeassistant --config /config --script check_config --info all || {
              echo "âš ï¸  Home Assistant configuration check found issues."
              echo "This may be due to missing secrets or integrations that require specific hardware/services."
              echo "Please review the output above for specific errors."
              echo ""
              echo "Common solutions:"
              echo "1. Add missing secrets to a real secrets.yaml file"
              echo "2. Ensure custom integrations are properly configured"
              echo "3. Check that all referenced entities exist"
              echo ""
              echo "Note: Some errors are expected in CI environment due to missing hardware/services."
              exit 1
            }
        env:
          # Suppress warnings for missing integrations in CI
          PYTHONPATH: /usr/src/homeassistant

  markdown-lint:
    name: "Markdown Linting"
    runs-on: "ubuntu-24.04"
    steps:
      - name: "Checkout Repository"
        uses: "actions/checkout@v4"
        
      - name: "Install markdownlint"
        run: npm install -g markdownlint-cli2
        
      - name: "Run markdownlint (excluding auto-generated README)"
        run: |
          # Check if there are any markdown files to lint (excluding auto-generated README)
          if find . -name "*.md" -not -name "README.md" | head -1 | read; then
            markdownlint-cli2 "**/*.md" --ignore README.md
          else
            echo "No markdown files to lint (excluding auto-generated README.md)"
          fi

  validation-summary:
    name: "Validation Summary"
    runs-on: "ubuntu-24.04"
    needs: [yaml-lint, hassfest, esphome-check, home-assistant-check, markdown-lint]
    if: always()
    steps:
      - name: "Check validation results"
        run: |
          echo "## Validation Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check each job result
          if [[ "${{ needs.yaml-lint.result }}" == "success" ]]; then
            echo "âœ… YAML Linting: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ YAML Linting: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.hassfest.result }}" == "success" ]]; then
            echo "âœ… hassfest validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ hassfest validation: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.esphome-check.result }}" == "success" ]] || [[ "${{ needs.esphome-check.result }}" == "skipped" ]]; then
            echo "âœ… ESPHome validation: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ ESPHome validation: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.home-assistant-check.result }}" == "success" ]]; then
            echo "âœ… Home Assistant config check: Passed" >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ needs.home-assistant-check.result }}" == "failure" ]]; then
            echo "âš ï¸  Home Assistant config check: Failed (may include expected CI limitations)" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Home Assistant config check: Error" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.markdown-lint.result }}" == "success" ]]; then
            echo "âœ… Markdown linting: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Markdown linting: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Overall result - Home Assistant check failure is not blocking due to expected CI limitations
          if [[ "${{ needs.yaml-lint.result }}" == "success" ]] && \
             [[ "${{ needs.hassfest.result }}" == "success" ]] && \
             ([[ "${{ needs.esphome-check.result }}" == "success" ]] || [[ "${{ needs.esphome-check.result }}" == "skipped" ]]) && \
             [[ "${{ needs.markdown-lint.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŽ‰ **Core validations passed successfully!**" >> $GITHUB_STEP_SUMMARY
            if [[ "${{ needs.home-assistant-check.result }}" != "success" ]]; then
              echo "â„¹ï¸  Note: Home Assistant config check had issues, which may be expected in CI environment." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Some core validations failed. Please check the logs above.**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi